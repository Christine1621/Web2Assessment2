<!-- Declare the document type to HTML and set the language to English -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="style.css">
  <title>Search fundraisers page</title>
</head>

<body>
  <nav>
    <a href="index.html">Home page</a>
    <a href="Fundraisers.html">Search fundraisers page</a>
  </nav>
  <header>
    <h1 class="title">Search fundraisers page</h1>
  </header>

  <div class="content">
  </div>
  <div class="content">
    <form id="search-form">
      <!-- Create a search box -->
      <div class="search-box">
        <!-- Input box to enter the name of the fundraiser or city for the search -->
        <input type="text" id="searchInput" class="input" placeholder="Search for fundraiser name or city." />
        <!-- search button, when clicked, call the searchClickHandler function -->
        <button onclick="searchClickHandler(event)">Search</button>
      </div>

      <p>Organizer:</p>
      <!-- Create a filter with the organizer's selection -->
      <div class="searchFilterItem">
        <label for="leo">
          <input type="checkbox" id="leo" name="organizer" value="Leo"> Leo
        </label>
        <label for="david">
          <input type="checkbox" id="david" name="organizer" value="David"> David
        </label>
        <label for="emma">
          <input type="checkbox" id="emma" name="organizer" value="Emma"> Emma
        </label>
        <label for="mike">
          <input type="checkbox" id="mike" name="organizer" value="Mike"> Mike
        </label>
        <label for="edith">
          <input type="checkbox" id="edith" name="organizer" value="Edith"> Edith
        </label>
        <label for="kevin">
          <input type="checkbox" id="kevin" name="organizer" value="Kevin"> Kevin
        </label>
        <label for="erin">
          <input type="checkbox" id="erin" name="organizer" value="Erin"> Erin
        </label>
        <label for="tom">
          <input type="checkbox" id="tom" name="organizer" value="Tom"> Tom
        </label>
        <label for="ivy">
          <input type="checkbox" id="ivy" name="organizer" value="Ivy"> Ivy
        </label>
        <label for="lucy">
          <input type="checkbox" id="lucy" name="organizer" value="Lucy"> Lucy
        </label>
      </div>

      <p>City:</p>
      <div class="searchFilterItem">
        <label for="sydney">
          <input type="checkbox" id="sydney" name="city" value="Sydney"> Sydney
        </label>
        <label for="melbourne">
          <input type="checkbox" id="melbourne" name="city" value="Melbourne"> Melbourne
        </label>
        <label for="canberra">
          <input type="checkbox" id="canberra" name="city" value="Canberra"> Canberra
        </label>
        <label for="darwin">
          <input type="checkbox" id="darwin" name="city" value="Darwin"> Darwin
        </label>
        <label for="brisbane">
          <input type="checkbox" id="brisbane" name="city" value="Brisbane"> Brisbane
        </label>
        <label for="hobart">
          <input type="checkbox" id="hobart" name="city" value="Hobart"> Hobart
        </label>
        <label for="armidale">
          <input type="checkbox" id="armidale" name="city" value="Armidale"> Armidale
        </label>
      </div>

      <p>Category:</p>
      <div class="searchFilterItem">
        <label for="health">
          <input type="checkbox" id="health" name="category" value="1"> Health
        </label>
        <label for="environment">
          <input type="checkbox" id="environment" name="category" value="2"> Environment
        </label>
        <label for="community-support">
          <input type="checkbox" id="community-support" name="category" value="3"> Community Support
        </label>
        <label for="education">
          <input type="checkbox" id="education" name="category" value="4"> Education
        </label>
      </div>
      <!-- Submit the search button -->
      <button type="submit" onclick="searchFundraisers(event)">Search</button>
      <!-- Trigger the button to clear the checkbox -->
      <button type="button" onclick="clearCheckboxes()">Clear</button>
    </form>

    <div id="error-message" style="color: red; display: none;"></div>
    <!-- section for displaying search results -->
    <section id="results"></section>
  </div>

  <script>
    //Functions that clear all check boxes
    function clearCheckboxes() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      //Iterate through each checkbox and set its status to Unchecked
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
      document.getElementById('error-message').textContent = '';// Clear the error message
      document.getElementById('results').innerHTML = '';// Clear the search results
    }
    // An asynchronous function to search for fundraisers
    async function searchFundraisers(event) {
      event.preventDefault();//Blocks the default submission behavior of forms
      const selectedOrganizers = Array.from(document.querySelectorAll('input[name="organizer"]:checked')).map(cb => cb.value);
      const selectedCities = Array.from(document.querySelectorAll('input[name="city"]:checked')).map(cb => cb.value);
      const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => cb.value);
      const resultsDiv = document.getElementById('results');
      const errorMessage = document.getElementById('error-message');
      //Clear previous search results and error messages
      resultsDiv.innerHTML = '';
      errorMessage.textContent = '';

      //Check that at least one filter is selected
      if (selectedOrganizers.length === 0 && selectedCities.length === 0 && selectedCategories.length === 0) {
        errorMessage.textContent = 'Please select at least one criterion.';
        errorMessage.style.display = 'block';
        return;
      }
      //Get a list of fundraisers
      const fundraisers = await getList();
      //Filter fundraisers based on the criteria you select
      const filtered = fundraisers.filter(fundraiser => {
        return (selectedOrganizers.length === 0 || selectedOrganizers.includes(fundraiser.ORGANIZER)) &&
          (selectedCities.length === 0 || selectedCities.includes(fundraiser.CITY)) &&
          (selectedCategories.length === 0 || selectedCategories.includes(String(fundraiser.CATEGORY_ID)));
      });

      //Check to see if there is an eligible fundraiser
      if (filtered.length > 0) {
        filtered.forEach(fundraiser => {//Go through all eligible fundraisers
          const element = genSearchResultElementList([fundraiser]);//Generate and get search result elements
          document.getElementById('results').innerHTML = element;//The updated results area shows the element
        });
      } else {
        //If it doesn't find an eligible fundraiser, you'll see a tooltip
        resultsDiv.innerHTML = '<strong style="color: red;">No eligible fundraisers were found.</strong>';
      }
    }

    function getList() {
      return new Promise((resolve, reject) => { //Define a function called getList that returns a Promise object
        fetch('http://localhost:3000/api/fundraisers')// Use the fetch API to request data from a specified URL
          .then(response => response.json())// Convert the response data to JSON format
          .then(fundraisers => {
            resolve(fundraisers)
          })
      })
    }
    //Obtain the input box element with the id "searchInput" on the page
    const searchInput = document.getElementById("searchInput");
    //Define a function that handles search click events asynchronously
    async function searchClickHandler(e) {
      event.preventDefault();//Block default events
      const value = searchInput.value.toLocaleLowerCase();
      if (!value.trim()) {
        return;
      }
      //Call the getList function to get a list of fundraisers
      const fundraisers = await getList();
      const filterData = fundraisers.filter(item => {
        return Object.values(item).some(e => {
          return String(e).toLocaleLowerCase().includes(value);
        });
      });
      //A list of elements that generate search results
      const element = genSearchResultElementList(filterData);
      document.getElementById('results').innerHTML = element;
    }

    function genSearchResultElementList(data) {
      if (!Array.isArray(data)) {
        return null;
      }
      // Generate a corresponding HTML element string for each fundraiser
      return data.map(fundraiser => {
        return `
          <div>
            <h3 style="margin-bottom: 5px;">${fundraiser.CAPTION}</h3>
            <p>Fundraiser ID: ${fundraiser.FUNDRAISER_ID}</p>
            <p>Organizer: ${fundraiser.ORGANIZER}</p>
            <p>Target Funding: $${fundraiser.TARGET_FUNDING}</p>
            <p>Current Funding: $${fundraiser.CURRENT_FUNDING}</p>
            <p>City: ${fundraiser.CITY}</p>
            <p>Active: ${fundraiser.ACTIVE ? 'Yes' : 'No'}</p>
            <p>Category: ${fundraiser.CATEGORY_ID}</p>
            <div class="centered-link">
                <a href="Leo.html?id=${fundraiser.FUNDRAISER_ID}">View Details</a>
            </div>
          </div>
        `
      }).join("");// Convert arrays to strings and concatenate them with empty strings
    }
  </script>
</body>

</html>